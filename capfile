Bundler.require(:deployer)
load "sonoma/remote/tasks/all.rake"

verify = lambda do |host|
  deployed_correct_version = false
  on(host) do
    response = capture("curl", "localhost/status")
    json_response = JSON.parse(response)
    deployed_correct_version = (json_response["revision"] == fetch(:revision))
  end
  deployed_correct_version
end

docker_options =  lambda do
  [
    "-e HOSTS_IN_ENVIRONMENT=[#{roles(:app).collect(&:hostname).join(',')}]",
    "-v /var/groupon/#{fetch(:application)}/log:/usr/src/app/log",
    "-v /var/groupon/#{fetch(:application)}/config/local:/usr/src/app/config/local"
  ]
end

registry = (ENV["DOCKER_REGISTRY"] || "docker.groupondev.com")

Sonoma::Remote.configure!({
  application: "ga",
  docker_options: docker_options,
  docker_registry: registry,
  docker_repository: "gurus/groupon-gurus",
  hipchat_token: "IeKYgW4T2v4Uham9DSUasNEoy87cnuRjT9sBeEA7",
  load_balancer_delay: 3,
  server_boot_time: 6,
  user: "ga_deploy",
  verify: verify
})
